{% extends "_layout.html" %}
{% block content %}
<div class="card mt-4">
    <div class="card-header bg-dark bg-gradient text-white">
        <h4 class="card-title">{{ task.name }} [ <a href="{{url_for('tasks.edit_task', task_id=task.id)}}"><i
                    class="fa-solid fa-pen"></i></a> ]</h4>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-12">
                <!-- Resource Type Badge -->
                {% if task.resource_type == 'P' %}
                <span class="badge text-bg-primary">{{ task.resource_type }}</span>
                {% else %}
                <span class="badge text-bg-success">{{ task.resource_type }}</span>
                {% endif %}

                <!-- Priority Badge -->
                {% if task.priority == 'High' %}
                <span class="badge text-bg-danger">{{ task.priority }}</span>
                {% elif task.priority == 'Medium' %}
                <span class="badge text-bg-warning">{{ task.priority }}</span>
                {% else %}
                <span class="badge text-bg-primary">{{ task.priority }}</span>
                {% endif %}

                <!-- Category Badge -->
                <span class="badge text-bg-secondary">{{ task.category }}</span>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-12 d-flex align-items-center">
                <strong class="mr-2"><i class="fa-solid fa-arrow-up-right-from-square"></i> External
                    Link:&nbsp;</strong>
                <a href="{{ task.external_link }}" class="d-inline-block"> {{ task.external_link }}</a>
            </div>
        </div>
        <div class="row">
            <div class="col-md-8 border-right">
                <h5><i class="fa-solid fa-circle-info"></i> Description</h5>
                {{ markdowner.convert(task.description) | safe }}

                {% if task.attachments %}
                <div class="mt-4">
                    <h5><i class="fa-solid fa-paperclip"></i> Attachments</h5>
                    <div class="attachments-grid">
                        {% for attachment in task.attachments %}
                            {% set filename = attachment.filename %}
                            <div class="attachment-section mb-3">
                                {% if filename.lower().endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
                                    <div class="image-container">
                                        <img src="{{ url_for('tasks.view_attachment', attachment_id=attachment.id) }}" 
                                             alt="Attachment preview" 
                                             class="preview-image"
                                             data-bs-toggle="modal" 
                                             data-bs-target="#attachmentModal{{ attachment.id }}">
                                        <form action="{{ url_for('tasks.delete_attachment', attachment_id=attachment.id) }}" 
                                              method="POST" 
                                              class="delete-overlay"
                                              onclick="return confirm('Are you sure you want to delete this attachment?')">
                                            <button type="submit" class="btn btn-delete">
                                                <i class="fa-solid fa-times"></i>
                                            </button>
                                        </form>
                                    </div>
                                {% elif filename.lower().endswith('.pdf') %}
                                    <div class="pdf-container">
                                        <iframe src="{{ url_for('tasks.view_attachment', attachment_id=attachment.id) }}" 
                                               class="pdf-preview"></iframe>
                                        <form action="{{ url_for('tasks.delete_attachment', attachment_id=attachment.id) }}" 
                                              method="POST" 
                                              class="delete-overlay"
                                              onclick="return confirm('Are you sure you want to delete this attachment?')">
                                            <button type="submit" class="btn btn-delete">
                                                <i class="fa-solid fa-times"></i>
                                            </button>
                                        </form>
                                        <a href="{{ url_for('tasks.view_attachment', attachment_id=attachment.id) }}" 
                                           target="_blank"
                                           class="btn btn-sm btn-outline-primary view-full-size">
                                            <i class="fa-solid fa-expand"></i> View Full Size
                                        </a>
                                    </div>
                                {% elif filename.lower().endswith(('.txt', '.css', '.js', '.html')) %}
                                    <div class="text-container">
                                        <iframe src="{{ url_for('tasks.view_attachment', attachment_id=attachment.id) }}" 
                                                class="text-preview"></iframe>
                                        <form action="{{ url_for('tasks.delete_attachment', attachment_id=attachment.id) }}" 
                                              method="POST" 
                                              class="delete-overlay"
                                              onclick="return confirm('Are you sure you want to delete this attachment?')">
                                            <button type="submit" class="btn btn-delete">
                                                <i class="fa-solid fa-times"></i>
                                            </button>
                                        </form>
                                        <button class="btn btn-sm btn-outline-primary view-full-size" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#attachmentModal{{ attachment.id }}">
                                            <i class="fa-solid fa-expand"></i> View Full Size
                                        </button>
                                    </div>
                                {% else %}
                                    <div class="placeholder-container">
                                        <form action="{{ url_for('tasks.delete_attachment', attachment_id=attachment.id) }}" 
                                              method="POST" 
                                              class="delete-overlay"
                                              onclick="return confirm('Are you sure you want to delete this attachment?')">
                                            <button type="submit" class="btn btn-delete">
                                                <i class="fa-solid fa-times"></i>
                                            </button>
                                        </form>
                                        <div class="placeholder-content" onclick="showPreviewMessage(event)">
                                            <i class="fa-solid fa-file fa-3x text-secondary"></i>
                                            <p class="mt-2 text-muted text-break">{{ attachment.original_filename }}</p>
                                            <small class="text-muted mt-1">Preview not available</small>
                                            <a href="{{ url_for('tasks.download_attachment', attachment_id=attachment.id) }}" 
                                               class="btn btn-sm btn-outline-primary mt-3"
                                               onclick="event.stopPropagation()">
                                                <i class="fa-solid fa-download"></i> Download
                                            </a>
                                        </div>
                                    </div>
                                {% endif %}

                                {% if filename.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.txt', '.css', '.js', '.html')) %}
                                    <div class="modal fade" id="attachmentModal{{ attachment.id }}" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog modal-xl modal-dialog-centered">
                                            <div class="modal-content">
                                                <div class="modal-body">
                                                    {% if filename.lower().endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
                                                        <img src="{{ url_for('tasks.view_attachment', attachment_id=attachment.id) }}" 
                                                             alt="Attachment preview">
                                                    {% else %}
                                                        <iframe src="{{ url_for('tasks.view_attachment', attachment_id=attachment.id) }}">
                                                        </iframe>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="col-md-4">
                <h5><i class="fa-solid fa-bars-progress"></i> Progress</h5>
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" data-progress="{{ task.progress_counter }}" 
                        aria-valuenow="{{ task.progress_counter }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <h5><i class="fa-solid fa-calendar-days"></i> Date of Allotment</h5>
                <p>{{ task.date_of_allotment }}</p>
                <h5><i class="fa-solid fa-flag-checkered"></i> Due Date</h5>
                <p>{{ task.due_date }}</p>
                {% if task.time_spent != None %}
                <h5><i class="fa-solid fa-calendar-days"></i> Time Spent</h5>
                <p>{{ task.time_spent }} days</p>
                {% endif %}
                {% if task.close_date != None %}
                <h5><i class="fa-solid fa-calendar-days"></i> Date Closed</h5>
                <p>{{ task.close_date }}</p>
                {% else %}
                {% if task.due_date != None %}
                <h5><i class="fa-solid fa-bell"></i> Days Remaining</h5>
                <h5 class="display-6">{{ (task.due_date - datetime.date.today()).days }}</h5>
                {% endif %}
                {% endif %}
                <h5><i class="fa-solid fa-ban"></i> Blockers</h5>
                <p class="border py-1 px-2" style="min-height: 100px;">{{ task.blockers }}</p>
            </div>
        </div>
    </div>
</div>

<style>
.attachment-section {
    background-color: #f8f9fa;
    border-radius: 4px;
    padding: 15px;
    border: 1px solid #dee2e6;
}

.attachment-preview {
    margin-top: 10px;
}

.image-container, .pdf-container, .text-container, .placeholder-container {
    width: 300px;
    height: 200px;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
    background-color: #f8f9fa;
    border-radius: 4px;
}

.image-container {
    cursor: pointer;
}

.placeholder-container {
    cursor: default;
}

.delete-overlay {
    position: absolute;
    top: 5px;
    right: 5px;
    z-index: 10;
    margin: 0;
    padding: 0;
}

.btn-delete {
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.btn-delete:hover {
    background: rgba(220, 53, 69, 1);
    transform: scale(1.1);
}

.btn-delete i {
    font-size: 14px;
}

.preview-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    padding: 0;
}

.preview-image:hover {
    transform: none;
}

.pdf-preview, .text-preview {
    width: 100%;
    height: 100%;
    border: none;
    background-color: white;
}

.modal-xl {
    max-width: 90%;
}

.modal-body {
    padding: 0;
    background-color: white;
    height: 85vh;
}

.modal-content {
    background-color: white;
    border: none;
    height: 85vh;
}

.modal-body img, 
.modal-body iframe {
    width: 100%;
    height: 85vh;
    background-color: white;
    border-radius: 4px;
}

.pdf-modal-view {
    width: 100%;
    height: 85vh;
    border: none;
    background-color: white;
}

.placeholder-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    text-align: center;
    width: 100%;
}

.placeholder-content p {
    margin: 0;
    font-size: 0.9rem;
    max-width: 100%;
    word-wrap: break-word;
}

.preview-message {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    z-index: 1050;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.preview-message.show {
    opacity: 1;
}

.view-full-size {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 5;
}

.attachments-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 15px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const progressBar = document.querySelector('.progress-bar');
    const progress = progressBar.dataset.progress;
    progressBar.style.width = progress + '%';
});

const messageElement = document.createElement('div');
messageElement.className = 'preview-message';
messageElement.textContent = 'Preview not available for this file type';
document.body.appendChild(messageElement);

let messageTimeout;

function showPreviewMessage(event) {
    if (event.target.tagName !== 'A') {
        messageElement.classList.add('show');
        
        if (messageTimeout) {
            clearTimeout(messageTimeout);
        }
        
        messageTimeout = setTimeout(() => {
            messageElement.classList.remove('show');
        }, 2000);
    }
}
</script>
{% endblock %}